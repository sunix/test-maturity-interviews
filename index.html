<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Maturity Assessment</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Evaluate and track testing maturity across teams and applications">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Test Maturity">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
    
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script>
        // Centralized initialization on page load
        window.addEventListener('load', function() {
            // Check Chart.js availability
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js failed to load from CDN. Radar chart will not be available.');
                const chartContainer = document.querySelector('.chart-container');
                if (chartContainer) {
                    chartContainer.innerHTML = '<p class="alert alert-warning">Chart visualization unavailable. Chart.js library could not be loaded.</p>';
                }
            }
            
            // Display app version in header
            displayAppVersion();
        });
        
        // Function to display app version
        function displayAppVersion() {
            const versionElement = document.getElementById('app-version');
            if (versionElement && typeof APP_VERSION !== 'undefined') {
                versionElement.textContent = `v${APP_VERSION}`;
            }
        }
    </script>
</head>
<body>
    <!-- Preview Banner -->
    <div id="preview-banner" style="display: none; position: fixed; top: 0; left: 0; right: 0; z-index: 9999; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; gap: 12px;">
        <div style="font-size: 24px; flex-shrink: 0;">üî¨</div>
        <div style="flex: 1; color: white;">
          <strong style="display: block; font-size: 14px;">Preview Environment</strong>
          <span style="display: block; font-size: 12px; opacity: 0.9;">This is not the official site - Test environment only</span>
        </div>
        <a id="preview-banner-pr-link" href="#" style="display: none; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; transition: background 0.2s ease; flex-shrink: 0; align-items: center; gap: 6px; text-decoration: none;" target="_blank" rel="noopener noreferrer">
          üí¨ Give feedback on the PR
        </a>
        <button id="preview-banner-close" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 50%; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s ease; flex-shrink: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;" aria-label="Close">‚úï</button>
      </div>
    </div>
    
    <div class="sticky-header">
        <div class="container">
            <header>
                <div class="header-content">
                    <div class="header-left">
                        <div class="header-title">
                            <h1>üéØ Test Maturity Assessment</h1>
                            <p class="subtitle">
                                Evaluate and track testing maturity across teams and applications
                                <span id="app-version" class="app-version" title="Current application version"></span>
                            </p>
                        </div>
                        <nav class="tabs tabs-desktop">
                            <button class="tab-button active" data-tab="interview">Interview</button>
                            <button class="tab-button" data-tab="data">Data</button>
                            <button class="tab-button" data-tab="question-editor">Question editor</button>
                            <button class="tab-button" data-tab="results">Results</button>
                        </nav>
                    </div>
                    <div class="header-right">
                        <button id="hamburger-menu" class="hamburger-btn" aria-label="Menu">
                            <span></span>
                            <span></span>
                            <span></span>
                        </button>
                        <div class="header-sync-status">
                            <div id="header-sync-indicator" class="sync-indicator sync-no-folder">
                                <span class="sync-status-dot"></span>
                                <div class="sync-info">
                                    <span class="sync-folder-name">No sync folder</span>
                                    <span class="sync-status-text">Not syncing</span>
                                </div>
                            </div>
                            <button id="header-select-sync-folder" class="btn btn-sync" title="Select sync folder">üìÅ</button>
                        </div>
                    </div>
                </div>
            </header>

            <nav class="tabs tabs-mobile">
                <button class="tab-button active" data-tab="interview">Interview</button>
                <button class="tab-button" data-tab="data">Data</button>
                <button class="tab-button" data-tab="question-editor">Question editor</button>
                <button class="tab-button" data-tab="results">Results</button>
            </nav>

            <!-- Update Available Banner -->
            <div id="update-banner" class="update-banner hidden">
                <div class="update-banner-content">
                    <span class="update-icon">üîÑ</span>
                    <span class="update-message">A new version is available!</span>
                    <button id="update-reload-btn" class="btn btn-primary btn-small">Update Now</button>
                    <button id="update-dismiss-btn" class="btn btn-secondary btn-small">Dismiss</button>
                </div>
            </div>

            <!-- Interview Controls (shown only on interview tab) -->
            <div id="interview-controls" class="interview-controls hidden">
                <div class="interview-controls-content">
                    <!-- Interview Metadata Editor Section -->
                    <div class="metadata-section collapsed">
                        <div class="metadata-header">
                            <button id="toggle-metadata-editor" class="metadata-toggle">
                                <span class="toggle-icon">‚ñ∂</span>
                                <span class="toggle-text">Edit Interview Metadata</span>
                            </button>
                        </div>
                        <div class="metadata-content">
                            <div class="form-group form-horizontal">
                                <label for="edit-app-name">Application Name:</label>
                                <input type="text" id="edit-app-name" class="form-control">
                            </div>
                            <div class="form-group form-horizontal">
                                <label for="edit-interview-name">Interview Name:</label>
                                <input type="text" id="edit-interview-name" class="form-control" placeholder="Team name, profile name, or group">
                            </div>
                            <div class="form-group">
                                <label>Interview Dates:</label>
                                <div id="interview-dates-container" class="interview-dates-container">
                                    <!-- Dates will be added dynamically -->
                                </div>
                                <button id="add-interview-date" class="btn btn-secondary btn-small">+ Add Date</button>
                                <small class="help-text">Add multiple dates if interview spans several sessions</small>
                            </div>
                            <div class="form-group">
                                <label for="edit-interviewees">Interviewees:</label>
                                <textarea id="edit-interviewees" rows="2" class="form-control" placeholder="Names of people interviewed"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="edit-general-comments">General Interview Comments:</label>
                                <textarea id="edit-general-comments" rows="4" class="form-control" placeholder="Add general notes, observations, or comments about this interview..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="interview-controls-row">
                        <div class="form-group profile-filter-group">
                            <label>Filter by Profiles:</label>
                            <div id="profile-filter" class="profile-filter-checkboxes">
                                <label class="profile-filter-checkbox">
                                    <input type="checkbox" value="developer"> Developer
                                </label>
                                <label class="profile-filter-checkbox">
                                    <input type="checkbox" value="qa"> QA Engineer
                                </label>
                                <label class="profile-filter-checkbox">
                                    <input type="checkbox" value="devops"> DevOps
                                </label>
                                <label class="profile-filter-checkbox">
                                    <input type="checkbox" value="manager"> Manager
                                </label>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                            <span class="progress-text" id="progress-text">0 / 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">

        <!-- Interview Tab -->
        <div id="interview" class="tab-content active">
            <!-- Interview Default View -->
            <div id="interview-default-view">
                <div class="card">
                    <h2>Start New Interview</h2>
                    <div class="form-group">
                        <label for="app-name">Application Name:</label>
                        <input type="text" id="app-name" placeholder="Enter application name">
                    </div>
                    <div class="form-group">
                        <label for="interview-name">Interview Name:</label>
                        <input type="text" id="interview-name" placeholder="Team name, profile name, or group identifier">
                        <small style="color: #64748b; display: block; margin-top: 0.25rem;">E.g., "Frontend Team", "Backend Developers", "QA Team Sprint 24"</small>
                    </div>
                    <div class="form-group">
                        <label for="interviewees">Interviewees:</label>
                        <textarea id="interviewees" rows="3" placeholder="Enter names of people interviewed (one per line or comma-separated)"></textarea>
                        <small style="color: #64748b; display: block; margin-top: 0.25rem;">E.g., "John Doe, Jane Smith" or one name per line</small>
                    </div>
                    <button id="start-interview" class="btn btn-primary">Start Interview</button>
                </div>

                <div class="card">
                    <h2>Existing Interviews</h2>
                    <div id="saved-assessments"></div>
                </div>
            </div>

            <!-- Interview Questionnaire View -->
            <div id="interview-questionnaire-view" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h2 id="interview-title">Interview Questions</h2>
                        <button id="back-to-interviews" class="btn btn-secondary">‚Üê Back to Interviews</button>
                    </div>
                    
                    <div id="questions-container"></div>
                    
                    <div class="interview-actions">
                        <div id="auto-save-status" class="auto-save-status"></div>
                        <button id="export-questionnaire" class="btn btn-secondary">üìù Export Questionnaire to Excel</button>
                        <button id="import-questionnaire" class="btn btn-secondary">üì• Import Filled Questionnaire</button>
                        <input type="file" id="import-questionnaire-file" accept=".xlsx,.xls" style="display: none;">
                        <button id="view-results" class="btn btn-secondary">üìä View Results</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Tab -->
        <div id="data" class="tab-content">
            <div class="card">
                <h2>Data Management</h2>
                <div class="data-actions">
                    <button id="export-data" class="btn btn-secondary">üì• Export Data (JSON)</button>
                    <button id="import-data" class="btn btn-secondary">üì§ Import Data (JSON)</button>
                    <button id="export-data-excel" class="btn btn-secondary">üìä Export to Excel</button>
                    <button id="select-sync-folder" class="btn btn-secondary" style="display: none;">üìÅ Select Sync Folder</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;">
                </div>
                <div id="sync-status" style="margin-top: 1rem;"></div>
            </div>
        </div>

        <!-- Question Editor Tab -->
        <div id="question-editor" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Question Editor</h2>
                    <div>
                        <button id="export-questions-excel" class="btn btn-secondary">üìä Export to Excel</button>
                        <button id="import-questions-excel" class="btn btn-secondary">üìã Import from Excel</button>
                        <button id="add-question-btn" class="btn btn-primary">+ Add Question</button>
                        <button id="reset-questions-btn" class="btn btn-secondary">Reset to Default</button>
                        <input type="file" id="import-questions-excel-file" accept=".xlsx,.xls" style="display: none;">
                    </div>
                </div>
                <div id="questions-status" class="alert alert-info" style="margin-bottom: 1rem;">
                    Using default questions. Click "Add Question" or edit existing questions to create a custom question set.
                </div>
                <div id="questions-list-container"></div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="tab-content">
            <div class="card">
                <h2>Maturity Results</h2>
                <div class="form-group">
                    <label for="results-select">Select Assessment:</label>
                    <select id="results-select">
                        <option value="">Choose an assessment...</option>
                    </select>
                    <button id="export-results-excel" class="btn btn-secondary" style="margin-left: 1rem;">üìä Export to Excel</button>
                </div>
                <div id="results-container">
                    <div class="chart-container">
                        <canvas id="maturity-chart"></canvas>
                    </div>
                    <div id="theme-scores"></div>
                </div>
            </div>
        </div>

    </div>

    <script src="questions.js"></script>
    <script src="app.js"></script>
    
    <!-- Preview Banner Script -->
    <script>
    (function() {
      // Show banner only on surge.sh or preview environments
      if (window.location.hostname.includes('surge.sh') || window.location.hostname.includes('preview')) {
        var banner = document.getElementById('preview-banner');
        var closeBtn = document.getElementById('preview-banner-close');
        var prLink = document.getElementById('preview-banner-pr-link');
        
        if (banner) {
          banner.style.display = 'block';
          document.body.style.paddingTop = '60px';
        }
        
        // Extract PR number from hostname (format: pr-[NUMBER]-test-maturity-preview.surge.sh)
        var hostname = window.location.hostname;
        var prMatch = hostname.match(/^pr-(\d+)-/);
        if (prMatch && prMatch[1] && prLink) {
          var prNumber = prMatch[1];
          // Validate PR number contains only digits (additional safety check)
          if (/^\d+$/.test(prNumber)) {
            prLink.href = 'https://github.com/sunix/test-maturity-interviews/pull/' + encodeURIComponent(prNumber);
            prLink.style.display = 'inline-flex';
          }
        }
        
        if (closeBtn) {
          closeBtn.addEventListener('click', function() {
            if (banner) {
              banner.style.display = 'none';
              document.body.style.paddingTop = '0';
            }
          });
          
          // Add hover effect to close button
          closeBtn.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(255,255,255,0.35)';
          });
          closeBtn.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(255,255,255,0.2)';
          });
        }
        
        if (prLink) {
          prLink.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(255,255,255,0.35)';
          });
          prLink.addEventListener('mouseleave', function() {
            this.style.background = 'rgba(255,255,255,0.2)';
          });
        }
      }
    })();
    </script>

    <!-- Question Editor Modal -->
    <div id="question-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add Question</h3>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="question-form">
                    <div class="form-group">
                        <label for="question-theme">Theme: *</label>
                        <select id="question-theme" required>
                            <option value="">Select a theme...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="question-id">Question ID: *</label>
                        <input type="text" id="question-id" placeholder="e.g., GO-24" required>
                        <span id="id-error" class="error-message" style="display: none;"></span>
                    </div>
                    <div class="form-group">
                        <label for="question-profiles">Profiles: *</label>
                        <div id="question-profiles" class="checkbox-group checkbox-group-left">
                            <label><input type="checkbox" value="all" id="profile-all"> All</label>
                            <label><input type="checkbox" value="developer"> Developer</label>
                            <label><input type="checkbox" value="qa"> QA Engineer</label>
                            <label><input type="checkbox" value="devops"> DevOps</label>
                            <label><input type="checkbox" value="manager"> Manager</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="question-text">Question Text: *</label>
                        <textarea id="question-text" rows="3" placeholder="Enter the question text..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="question-category">Category:</label>
                        <input type="text" id="question-category" list="category-suggestions" placeholder="e.g., Test automation">
                        <datalist id="category-suggestions">
                            <option value="CI/CD">
                            <option value="Communication">
                            <option value="Communication & reporting">
                            <option value="Compliance">
                            <option value="Continuous improvement">
                            <option value="Defect management">
                            <option value="Estimating and planning">
                            <option value="Methodology practice">
                            <option value="Metrics">
                            <option value="Stakeholder commitment">
                            <option value="Test automation">
                            <option value="Test case design">
                            <option value="Test data">
                            <option value="Test environment">
                            <option value="Test organization">
                            <option value="Test process management">
                            <option value="Test strategy">
                            <option value="Test tools">
                            <option value="Testware management">
                            <option value="Training">
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label for="question-weight">Weight: *</label>
                        <input type="number" id="question-weight" min="1" max="5" value="2" required>
                        <small>Weight from 1 (low importance) to 5 (high importance)</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-question">Save Question</button>
            </div>
        </div>
    </div>
    
    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality with update detection
        if ('serviceWorker' in navigator) {
            let refreshing = false;
            let registration = null;
            
            // Detect when service worker update is available
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
            
            window.addEventListener('load', () => {
                // Register service worker
                navigator.serviceWorker.register('/test-maturity-interviews/service-worker.js')
                    .then((reg) => {
                        registration = reg;
                        console.log('Service Worker registered successfully:', reg.scope);
                        
                        // Check for updates immediately on load
                        registration.update()
                            .then(() => {
                                console.log('Initial update check completed');
                            })
                            .catch((error) => {
                                console.error('Initial update check failed:', error);
                            });
                        
                        // Check for updates every 60 seconds when app is active
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                        
                        // Check for updates when page becomes visible
                        document.addEventListener('visibilitychange', () => {
                            if (!document.hidden) {
                                registration.update();
                            }
                        });
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('Update found! New service worker installing...');
                            
                            newWorker.addEventListener('statechange', () => {
                                console.log('Service worker state changed to:', newWorker.state);
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('New version available! Showing update banner...');
                                    showUpdateBanner(newWorker);
                                }
                            });
                        });
                        
                        // Check for already waiting worker after a brief delay to avoid race condition
                        setTimeout(() => {
                            if (reg.waiting) {
                                console.log('Service worker already waiting, showing banner immediately');
                                showUpdateBanner(reg.waiting);
                            }
                        }, 100);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
            
            // Show update banner
            function showUpdateBanner(newWorker) {
                const banner = document.getElementById('update-banner');
                const reloadBtn = document.getElementById('update-reload-btn');
                const dismissBtn = document.getElementById('update-dismiss-btn');
                
                if (!banner) return;
                
                banner.classList.remove('hidden');
                
                // Remove existing listeners to prevent duplicates
                const newReloadBtn = reloadBtn.cloneNode(true);
                const newDismissBtn = dismissBtn.cloneNode(true);
                reloadBtn.parentNode.replaceChild(newReloadBtn, reloadBtn);
                dismissBtn.parentNode.replaceChild(newDismissBtn, dismissBtn);
                
                // Update now button
                newReloadBtn.addEventListener('click', () => {
                    if (newWorker) {
                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                    }
                });
                
                // Dismiss button
                newDismissBtn.addEventListener('click', () => {
                    banner.classList.add('hidden');
                });
            }
            
            // Make registration available globally for manual update checks
            window.checkForUpdates = function() {
                if (registration) {
                    console.log('Checking for updates...');
                    registration.update()
                        .then(() => {
                            console.log('Update check completed');
                        })
                        .catch((error) => {
                            console.error('Update check failed:', error);
                        });
                } else {
                    console.log('Service worker not registered yet');
                }
            };
        }
    </script>
</body>
</html>
