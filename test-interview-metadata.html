<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Metadata Test - Backward Compatibility</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        h2 { color: #2563eb; margin-top: 0; }
        .test-case {
            border-left: 4px solid #2563eb;
            padding: 10px 15px;
            margin: 10px 0;
            background: #f0f7ff;
        }
        .pass { border-left-color: #10b981; background: #f0fdf4; }
        .fail { border-left-color: #ef4444; background: #fef2f2; }
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #1d4ed8; }
        .result { margin-top: 10px; font-weight: bold; }
        .result.pass { color: #10b981; }
        .result.fail { color: #ef4444; }
    </style>
</head>
<body>
    <h1>üß™ Interview Metadata Test</h1>
    <p>This page tests the backward compatibility of the new interview metadata fields.</p>

    <div class="test-section">
        <h2>Test Setup</h2>
        <p>We'll test the following scenarios:</p>
        <ol>
            <li>Loading old format assessments (v1.1.0 and earlier) without interview metadata</li>
            <li>Creating new assessments with interview metadata</li>
            <li>Mixing old and new format assessments</li>
            <li>Ensuring unique identification of assessments by name + interviewName</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>Test Cases</h2>
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
        <div id="test-results"></div>
    </div>

    <script>
        // Mock assessment structures for testing
        const oldFormatAssessment = {
            name: 'MyApp',
            profile: 'all',
            date: '2024-01-01T10:00:00.000Z',
            answers: {
                'GO-1': 'yes',
                'GO-2': 'no'
            },
            comments: {},
            answeredBy: {},
            attachments: {},
            appVersion: '1.1.0'
        };

        const newFormatAssessment = {
            name: 'MyApp',
            interviewName: 'Frontend Team',
            profile: 'all',
            date: '2024-01-15T10:00:00.000Z',
            interviewees: ['John Doe', 'Jane Smith'],
            selectedProfiles: ['developer', 'qa'],
            answers: {
                'GO-1': 'yes',
                'GO-2': 'yes'
            },
            comments: {},
            answeredBy: {},
            attachments: {},
            appVersion: '1.2.0'
        };

        const anotherInterviewSameApp = {
            name: 'MyApp',
            interviewName: 'Backend Team',
            profile: 'all',
            date: '2024-01-20T10:00:00.000Z',
            interviewees: ['Bob Johnson'],
            selectedProfiles: ['developer', 'devops'],
            answers: {
                'GO-1': 'no',
                'GO-2': 'yes'
            },
            comments: {},
            answeredBy: {},
            attachments: {},
            appVersion: '1.2.0'
        };

        function testOldFormatCompatibility() {
            const assessment = JSON.parse(JSON.stringify(oldFormatAssessment));
            
            // Simulate loadAssessment backward compatibility logic
            if (!assessment.interviewName) {
                assessment.interviewName = assessment.name;
            }
            if (!assessment.interviewees) {
                assessment.interviewees = [];
            }
            if (!assessment.selectedProfiles) {
                assessment.selectedProfiles = [];
            }

            const checks = [
                { name: 'interviewName defaults to name', pass: assessment.interviewName === 'MyApp' },
                { name: 'interviewees defaults to empty array', pass: Array.isArray(assessment.interviewees) && assessment.interviewees.length === 0 },
                { name: 'selectedProfiles defaults to empty array', pass: Array.isArray(assessment.selectedProfiles) && assessment.selectedProfiles.length === 0 },
                { name: 'Original fields preserved', pass: assessment.name === 'MyApp' && assessment.answers['GO-1'] === 'yes' }
            ];

            return {
                title: 'Test 1: Old Format Compatibility',
                checks: checks,
                passed: checks.every(c => c.pass)
            };
        }

        function testNewFormatFields() {
            const assessment = JSON.parse(JSON.stringify(newFormatAssessment));

            const checks = [
                { name: 'interviewName is set', pass: assessment.interviewName === 'Frontend Team' },
                { name: 'interviewees array populated', pass: assessment.interviewees.length === 2 && assessment.interviewees[0] === 'John Doe' },
                { name: 'selectedProfiles array populated', pass: assessment.selectedProfiles.length === 2 && assessment.selectedProfiles.includes('developer') },
                { name: 'All original fields present', pass: assessment.name === 'MyApp' && assessment.answers['GO-1'] === 'yes' }
            ];

            return {
                title: 'Test 2: New Format Fields',
                checks: checks,
                passed: checks.every(c => c.pass)
            };
        }

        function testUniqueIdentification() {
            const assessments = [
                JSON.parse(JSON.stringify(oldFormatAssessment)),
                JSON.parse(JSON.stringify(newFormatAssessment)),
                JSON.parse(JSON.stringify(anotherInterviewSameApp))
            ];

            // Apply backward compatibility to old format
            if (!assessments[0].interviewName) {
                assessments[0].interviewName = assessments[0].name;
            }

            // Check if we can distinguish between them
            const uniqueKeys = new Set();
            assessments.forEach(a => {
                const key = `${a.name}-${a.interviewName}`;
                uniqueKeys.add(key);
            });

            const checks = [
                { name: 'Can distinguish old format from new', pass: uniqueKeys.has('MyApp-MyApp') },
                { name: 'Can distinguish Frontend Team interview', pass: uniqueKeys.has('MyApp-Frontend Team') },
                { name: 'Can distinguish Backend Team interview', pass: uniqueKeys.has('MyApp-Backend Team') },
                { name: 'All three are unique', pass: uniqueKeys.size === 3 }
            ];

            return {
                title: 'Test 3: Unique Identification',
                checks: checks,
                passed: checks.every(c => c.pass)
            };
        }

        function testFilenameGeneration() {
            // Test filename generation for sync
            const tests = [
                {
                    assessment: oldFormatAssessment,
                    expectedPattern: /^assessment-MyApp-MyApp-\d{4}-\d{2}-\d{2}\.json$/
                },
                {
                    assessment: newFormatAssessment,
                    expectedPattern: /^assessment-MyApp-Frontend_Team-\d{4}-\d{2}-\d{2}\.json$/
                },
                {
                    assessment: anotherInterviewSameApp,
                    expectedPattern: /^assessment-MyApp-Backend_Team-\d{4}-\d{2}-\d{2}\.json$/
                }
            ];

            const checks = tests.map((test, idx) => {
                const safeName = test.assessment.name.replace(/[^a-z0-9_-]/gi, '_');
                const safeInterviewName = (test.assessment.interviewName || test.assessment.name).replace(/[^a-z0-9_-]/gi, '_');
                const dateStr = new Date(test.assessment.date).toISOString().split('T')[0];
                const filename = `assessment-${safeName}-${safeInterviewName}-${dateStr}.json`;
                
                return {
                    name: `Filename ${idx + 1}: ${filename}`,
                    pass: test.expectedPattern.test(filename)
                };
            });

            return {
                title: 'Test 4: Filename Generation',
                checks: checks,
                passed: checks.every(c => c.pass)
            };
        }

        function testIntervieweeParsing() {
            const testCases = [
                { input: 'John Doe, Jane Smith', expected: ['John Doe', 'Jane Smith'] },
                { input: 'John Doe\nJane Smith', expected: ['John Doe', 'Jane Smith'] },
                { input: 'John Doe,Jane Smith,Bob Johnson', expected: ['John Doe', 'Jane Smith', 'Bob Johnson'] },
                { input: '', expected: [] },
                { input: '  John Doe  ,  Jane Smith  ', expected: ['John Doe', 'Jane Smith'] }
            ];

            const checks = testCases.map(test => {
                const parsed = test.input
                    .split(/[,\n]/)
                    .map(name => name.trim())
                    .filter(name => name.length > 0);
                
                const pass = JSON.stringify(parsed) === JSON.stringify(test.expected);
                return {
                    name: `Parse "${test.input.substring(0, 30)}..." ‚Üí [${test.expected.join(', ')}]`,
                    pass: pass
                };
            });

            return {
                title: 'Test 5: Interviewee Parsing',
                checks: checks,
                passed: checks.every(c => c.pass)
            };
        }

        function runAllTests() {
            const tests = [
                testOldFormatCompatibility(),
                testNewFormatFields(),
                testUniqueIdentification(),
                testFilenameGeneration(),
                testIntervieweeParsing()
            ];

            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';

            tests.forEach(test => {
                const testDiv = document.createElement('div');
                testDiv.className = `test-case ${test.passed ? 'pass' : 'fail'}`;
                
                let html = `<h3>${test.passed ? '‚úì' : '‚úó'} ${test.title}</h3>`;
                html += '<ul>';
                test.checks.forEach(check => {
                    html += `<li style="color: ${check.pass ? '#10b981' : '#ef4444'}">${check.pass ? '‚úì' : '‚úó'} ${check.name}</li>`;
                });
                html += '</ul>';
                
                testDiv.innerHTML = html;
                resultsDiv.appendChild(testDiv);
            });

            // Summary
            const passed = tests.filter(t => t.passed).length;
            const total = tests.length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'result ' + (passed === total ? 'pass' : 'fail');
            summaryDiv.textContent = `Summary: ${passed}/${total} tests passed`;
            resultsDiv.appendChild(summaryDiv);
        }
    </script>
</body>
</html>
